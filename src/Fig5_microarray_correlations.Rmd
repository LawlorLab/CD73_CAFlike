---
title: "Fig5 Heatmap correlation matrices"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
editor_options: 
  chunk_output_type: console
---

## Overview

### This notebook loads 3 Ewings sarcoma patient tumor microarray datasets and correlates NT5E gene expression vs. every other gene (somewhat computationally intensive, run on high performance computing cluster). R correlation coefficients are saved for each gene for future use.

```{r}
here::i_am("src/Fig5_microarray_correlations.Rmd")
library(here)
here()

library(Hmisc)
library(dplyr)
```

# Ewing sarcoma patient tumor microarrays

## Download expression data

```{r}
#### To generate gene-by-gene correlation matrices, log2 expression data of Ewing sarcoma tumors were downloaded from the R2 database for GSE34620, GSE142162, GSE17679. Tidy tables with columns=genes and rows=samples were prepared if not already in this format. Only Ewings tumor samples were included.

#### Gene by gene correlations were generated by rcorr, subsetted to NT5E vs. all other genes, and p-values and R correlation coefficients were saved for further use.

gse17679_savola <- read.table(file=here("working_data", "gse17679_savola_edata.txt"), row.names = 1, header=T) #load gene by sample matrix
gse17679_savola <- gse17679_savola[,-1] #remove affymetrix IDs
gse17679_savola <-t(gse17679_savola) #matrices need to be transposed to correlate on gene name not sample
#GSE1769 contains duplicates, using n=44 (GSE17679 only), also excluded cell lines and non tumor samples

```

```{r}
#Repeat for GSE34620
gse34620_delattre <-  read.table(file=here("working_data", "gse34620_delattre_edata.txt"), row.names = 1, header=T)
gse34620_delattre <- gse34620_delattre[,-1]
gse34620_delattre <- t(gse34620_delattre)
```

```{r}
#Repeat for GSE142162
gse142162_surdez <-  read.table(file=here("working_data", "gse142162_surdez_edata.txt"), row.names = 1, header=T)
gse142162_surdez <- gse142162_surdez[,-1]
gse142162_surdez <-t(gse142162_surdez)
```


#Correlate data

```{r}
#Correlate microarrays
res_savola <- rcorr(as.matrix(gse17679_savola), type=c("pearson"))
write.csv(res_savola$r, file="savola_rcorr_r.csv")
write.csv(res_savola$P, file="savola_rcorr_P.csv")

res_surdez <- rcorr(as.matrix(gse142162_surdez), type=c("pearson"))
write.csv(res_surdez$r, file="surdez_rcorr_r.csv")
write.csv(res_surdez$P, file="surdez_rcorr_P.csv")

res_delattre <- rcorr(as.matrix(gse34620_delattre), type=c("pearson"))
write.csv(res_delattre$r, file="delattre_rcorr_r.csv")
write.csv(res_delattre$P, file="delattre_rcorr_P.csv")
```

##Subset on NT5E and save

```{r}
res_surdez <- rcorr(as.matrix(surdez), type=c("pearson"))
surdez_subset_pval <- res_surdez$P
surdez_subset_pval <- data.frame(surdez_subset_pval)
surdez_subset_pval <- select(surdez_subset_pval, 'NT5E')
write.csv(surdez_subset_corr, file=here("gene_lists", "surdez_subset_pval_NT5E.csv"))
surdez_subset_corr <- res_surdez$r
surdez_subset_corr <- data.frame(surdez_subset_corr)
surdez_subset_corr <- select(surdez_subset_corr, 'NT5E')
write.csv(surdez_subset_corr, file=here("gene_lists", "surdez_subset_corr_NT5E.csv"))

res_delattre <- rcorr(as.matrix(delattre), type=c("pearson"))
delattre_subset_pval <- res_delattre$P
delattre_subset_pval <- data.frame(delattre_subset_pval)
delattre_subset_pval <- select(delattre_subset_pval, 'NT5E')
write.csv(delattre_subset_corr, file=here("gene_lists", "delattre_subset_pval_NT5E.csv"))
delattre_subset_corr <- res_delattre$r
delattre_subset_corr <- data.frame(delattre_subset_corr)
delattre_subset_corr <- select(delattre_subset_corr, 'NT5E')
write.csv(delattre_subset_corr, file=here("gene_lists", "delattre_subset_corr_NT5E.csv"))

res_savola <- rcorr(as.matrix(savola), type=c("pearson"))
savola_subset_pval <- res_savola$P
savola_subset_pval <- data.frame(savola_subset_pval)
savola_subset_pval <- select(savola_subset_pval, 'NT5E')
write.csv(savola_subset_corr, file=here("gene_lists", "savola_subset_pval_NT5E.csv"))
savola_subset_corr <- res_savola$r
savola_subset_corr <- data.frame(savola_subset_corr)
savola_subset_corr <- select(savola_subset_corr, 'NT5E')
write.csv(savola_subset_corr, file=here("gene_lists", "savola_subset_corr_NT5E.csv"))
```



